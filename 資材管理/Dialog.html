<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <style>
        body {
            font-family: sans-serif;
            padding: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select,
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background-color: #45a049;
        }

        .hidden {
            display: none;
        }

        #loading {
            text-align: center;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- Loading Message -->
    <div id="loading">読み込み中...</div>

    <!-- Main Form -->
    <div id="mainForm" class="hidden">
        <h2 id="formTitle"></h2>

        <form id="dataForm" onsubmit="handleSubmit(event)">
            <input type="hidden" id="mode" name="mode">

            <!-- Item Selection -->
            <div class="form-group" id="itemGroup">
                <label id="itemLabel" for="itemId">項目を選択:</label>
                <select id="itemId" name="itemId">
                    <option value="" disabled selected>選択してください</option>
                    <!-- Options will be populated by GAS -->
                </select>
            </div>

            <!-- Material Order Fields (資材発注専用) -->
            <div class="form-group hidden" id="materialOrderFields">
                <label>資材と数量:</label>
                <div id="materialOrderList">
                    <!-- 資材フィールドが動的に追加される -->
                </div>
                <button type="button" id="addMaterialOrderBtn" class="hidden" style="background-color: #2196F3; margin-top: 10px; width: auto; padding: 5px 15px;">
                    資材を追加 (+)
                </button>
                <div id="maxMaterialOrdersMsg" class="hidden" style="color: #666; font-size: 12px; margin-top: 5px;">
                    最大10点まで発注できます
                </div>
            </div>

            <!-- BOM Registration Fields -->
            <div class="form-group hidden" id="bomProductGroup">
                <label for="productId">商品を選択:</label>
                <select id="productId" name="productId">
                    <option value="" disabled selected>選択してください</option>
                    <!-- Options will be populated by GAS -->
                </select>
            </div>

            <div class="form-group hidden" id="bomMaterialsGroup">
                <label>資材と必要数:</label>
                <div id="bomMaterialsList">
                    <!-- 資材フィールドが動的に追加される -->
                </div>
                <button type="button" id="addMaterialBtn" class="hidden" style="background-color: #2196F3; margin-top: 10px; width: auto; padding: 5px 15px;">
                    資材を追加 (+)
                </button>
                <div id="maxMaterialsMsg" class="hidden" style="color: #666; font-size: 12px; margin-top: 5px;">
                    最大8点まで登録できます
                </div>
            </div>

            <!-- Product Order Fields (商品受注専用) -->
            <div class="form-group hidden" id="productOrderFields">
                <label for="clientOrderNumber">相手先の発注番号 (7桁の数字):</label>
                <input type="text" id="clientOrderNumber" name="clientOrderNumber" pattern="[0-9]{7}" maxlength="7" placeholder="例: 1234567">
                
                <label for="productNameSelect" style="margin-top: 15px;">商品名を選択:</label>
                <select id="productNameSelect" name="productNameSelect" onchange="onProductNameSelected(this)">
                    <option value="" disabled selected>商品名を選択してください</option>
                    <!-- Options will be populated by GAS -->
                </select>
                
                <div style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; font-size: 12px; color: #666;">
                    <strong>または</strong> 商品番号を直接入力することもできます
                </div>
                
                <label for="productNumber" style="margin-top: 15px;">商品番号 (6桁の数字):</label>
                <input type="text" id="productNumber" name="productNumber" pattern="[0-9]{6}" maxlength="6" placeholder="例: 012345" onblur="onProductNumberInput(this)">
                
                <label for="productName" style="margin-top: 15px;">商品名:</label>
                <input type="text" id="productName" name="productName" placeholder="商品名（自動入力または手入力）">
                
                <label for="deliveryDate" style="margin-top: 15px;">納期:</label>
                <input type="date" id="deliveryDate" name="deliveryDate">
            </div>

            <!-- Quantity Selection -->
            <div class="form-group" id="quantityGroup">
                <label for="quantitySelect">数量:</label>
                <select id="quantitySelect" name="quantitySelect" onchange="toggleCustomQty(this)">
                    <option value="1600" selected>1600</option>
                    <option value="1200">1200</option>
                    <option value="800">800</option>
                    <option value="400">400</option>
                    <option value="200">200</option>
                    <option value="100">100</option>
                    <option value="custom">その他 (手入力)</option>
                </select>
            </div>

            <!-- Custom Quantity Input -->
            <div class="form-group hidden" id="customQtyGroup">
                <label for="customQty">数量 (手入力):</label>
                <input type="number" id="customQty" name="customQty" min="1">
            </div>

            <!-- Expected Receipt Date (資材発注専用) -->
            <div class="form-group hidden" id="expectedReceiptDateGroup">
                <label for="expectedReceiptDate">受領予定日:</label>
                <input type="date" id="expectedReceiptDate" name="expectedReceiptDate">
            </div>

            <!-- Delivery Response Fields (納期回答書作成専用) -->
            <div class="form-group hidden" id="deliveryResponseFields">
                <label for="orderDateSelect">受注日を選択:</label>
                <select id="orderDateSelect" name="orderDateSelect">
                    <option value="" disabled selected>受注日を選択してください</option>
                    <!-- Options will be populated by GAS -->
                </select>
            </div>

            <button type="submit">送信</button>
        </form>
    </div>

    <script>
        // Initialize form based on mode
        function init(mode, dataList, dataList2) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainForm').classList.remove('hidden');
            document.getElementById('mode').value = mode;

            const title = document.getElementById('formTitle');
            const itemLabel = document.getElementById('itemLabel');
            const select = document.getElementById('itemId');

            // すべてのグループを初期状態にリセット
            document.getElementById('itemGroup').style.display = 'block';
            document.getElementById('bomProductGroup').classList.add('hidden');
            document.getElementById('bomMaterialsGroup').classList.add('hidden');
            document.getElementById('productOrderFields').classList.add('hidden');
            document.getElementById('deliveryResponseFields').classList.add('hidden');
            document.getElementById('materialOrderFields').classList.add('hidden');
            document.getElementById('quantityGroup').style.display = 'block';
            document.getElementById('customQtyGroup').classList.add('hidden');
            document.getElementById('expectedReceiptDateGroup').classList.add('hidden');
            
            // BOM資材リストをクリア
            document.getElementById('bomMaterialsList').innerHTML = '';
            // 資材発注リストをクリア
            const materialOrderList = document.getElementById('materialOrderList');
            if (materialOrderList) {
                materialOrderList.innerHTML = '';
            }

            if (mode === 'ORDER_MATERIAL') {
                title.textContent = '資材発注';
                // 通常の項目選択を非表示
                document.getElementById('itemGroup').style.display = 'none';
                // 資材発注専用フィールドを表示
                document.getElementById('materialOrderFields').classList.remove('hidden');
                document.getElementById('addMaterialOrderBtn').classList.remove('hidden');
                document.getElementById('maxMaterialOrdersMsg').classList.remove('hidden');
                // 受領予定日フィールドを表示
                document.getElementById('expectedReceiptDateGroup').classList.remove('hidden');
                // 数量選択を非表示（資材発注では各資材ごとに数量を入力）
                document.getElementById('quantityGroup').style.display = 'none';
                document.getElementById('customQtyGroup').style.display = 'none';
                
                // 資材リストをグローバル変数に保存
                if (dataList && dataList.length > 0) {
                    window.materialOrderList = dataList;
                } else {
                    console.error('資材発注: 資材リストの設定に失敗');
                    window.materialOrderList = [];
                }
                
                // 資材発注フィールドカウントをリセット
                materialOrderFieldCount = 0;
                // 最初の資材フィールドを追加
                addMaterialOrderField(dataList);
                
                // 資材追加ボタンのイベントリスナーを設定
                const addBtn = document.getElementById('addMaterialOrderBtn');
                if (addBtn) {
                    // 既存のイベントリスナーを削除してから追加
                    const newBtn = addBtn.cloneNode(true);
                    addBtn.parentNode.replaceChild(newBtn, addBtn);
                    newBtn.addEventListener('click', function() {
                        addMaterialOrderField();
                    });
                }
            } else if (mode === 'RECEIVE_PRODUCT') {
                title.textContent = '商品受注';
                // 商品選択リストを非表示
                document.getElementById('itemGroup').style.display = 'none';
                // 商品受注専用フィールドを表示
                document.getElementById('productOrderFields').classList.remove('hidden');
                // 数量選択を表示
                document.getElementById('quantityGroup').style.display = 'block';
                
                // 商品名リストボックスを設定
                const productNameSelect = document.getElementById('productNameSelect');
                if (productNameSelect && dataList && dataList.length > 0) {
                    // 商品リストをグローバル変数に保存（商品番号入力時の検索用）
                    window.productList = dataList;
                    
                    dataList.forEach(item => {
                        if (item && item.productName && item.productNumber) {
                            const option = document.createElement('option');
                            option.value = item.productNumber;
                            option.textContent = item.productName + ' (' + item.productNumber + ')';
                            option.setAttribute('data-product-name', item.productName);
                            productNameSelect.appendChild(option);
                        }
                    });
                } else {
                    console.error('商品受注: 商品リストの設定に失敗');
                }
            } else if (mode === 'MANUFACTURE_PRODUCT') {
                title.textContent = '製造業者選択';
                itemLabel.textContent = '製造業者を選択:';
                // 数量選択を非表示
                document.getElementById('quantityGroup').style.display = 'none';
                document.getElementById('customQtyGroup').style.display = 'none';
                // 製造業者リストを設定
                if (dataList && dataList.length > 0 && select) {
                    dataList.forEach(item => {
                        if (item && item.id && item.name) {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name + ' (' + item.id + ')';
                            select.appendChild(option);
                        }
                    });
                } else {
                    console.error('製造業者選択: 製造業者リストの設定に失敗');
                }
            } else if (mode === 'REGISTER_BOM') {
                title.textContent = 'BOM登録';
                // 通常の項目選択を非表示
                document.getElementById('itemGroup').style.display = 'none';
                document.getElementById('quantityGroup').style.display = 'none';
                document.getElementById('customQtyGroup').style.display = 'none';
                document.getElementById('expectedReceiptDateGroup').classList.add('hidden');
                // BOM登録用フィールドを表示
                document.getElementById('bomProductGroup').classList.remove('hidden');
                document.getElementById('bomMaterialsGroup').classList.remove('hidden');
                document.getElementById('addMaterialBtn').classList.remove('hidden');
                document.getElementById('maxMaterialsMsg').classList.remove('hidden');
                
                // 商品リストを設定（DOMは既に表示されているため即座に設定可能）
                const productSelectAfter = document.getElementById('productId');
                if (productSelectAfter) {
                    // 既存のオプションをクリア（disabled selectedのオプションを除く）
                    while (productSelectAfter.options.length > 1) {
                        productSelectAfter.remove(1);
                    }
                    
                    // 商品リストを設定
                    if (dataList && dataList.length > 0) {
                        dataList.forEach(item => {
                            if (item && item.id && item.name) {
                                const option = document.createElement('option');
                                option.value = item.id;
                                option.textContent = item.name + ' (' + item.id + ')';
                                productSelectAfter.appendChild(option);
                            }
                        });
                    } else {
                        // エラーメッセージを表示
                        const errorOption = document.createElement('option');
                        errorOption.value = '';
                        errorOption.textContent = '商品が見つかりません';
                        errorOption.disabled = true;
                        productSelectAfter.appendChild(errorOption);
                    }
                }
                
                // 資材フィールドカウントをリセット
                materialFieldCount = 0;
                // 最初の資材フィールドを追加
                addBomMaterialField(dataList2);
                
                // 資材追加ボタンのイベントリスナーを設定
                const addBtn = document.getElementById('addMaterialBtn');
                if (addBtn) {
                    // 既存のイベントリスナーを削除してから追加
                    const newBtn = addBtn.cloneNode(true);
                    addBtn.parentNode.replaceChild(newBtn, addBtn);
                    newBtn.addEventListener('click', function() {
                        addBomMaterialField();
                    });
                }
            } else if (mode === 'CREATE_DELIVERY_RESPONSE') {
                title.textContent = '納期回答書作成';
                // すべての通常フィールドを非表示
                document.getElementById('itemGroup').style.display = 'none';
                document.getElementById('productOrderFields').style.display = 'none';
                document.getElementById('quantityGroup').style.display = 'none';
                document.getElementById('customQtyGroup').style.display = 'none';
                // 納期回答書作成専用フィールドを表示
                document.getElementById('deliveryResponseFields').classList.remove('hidden');
                
                // 受注日リストボックスを設定
                const orderDateSelect = document.getElementById('orderDateSelect');
                if (orderDateSelect && dataList && dataList.length > 0) {
                    dataList.forEach(item => {
                        if (item && item.id && item.name) {
                            const option = document.createElement('option');
                            option.value = item.id;
                            // 日付を読みやすい形式に変換
                            const dateObj = new Date(item.id);
                            const dateStr = dateObj.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
                            option.textContent = dateStr + ' (' + item.id + ')';
                            orderDateSelect.appendChild(option);
                        }
                    });
                } else {
                    console.error('納期回答書作成: 受注日リストの設定に失敗');
                }
            }

            // リストボックスの設定確認（開発時のみ）
            if (mode !== 'REGISTER_BOM' && mode !== 'CREATE_DELIVERY_RESPONSE' && select && select.options.length <= 1) {
                console.warn(`${mode}モード: リストボックスにオプションが設定されていません`);
            }
        }

        // BOM資材フィールドを追加
        let materialOptions = [];
        let materialFieldCount = 0;
        const MAX_MATERIALS = 8;

        // 資材発注フィールドを追加
        let materialOrderOptions = [];
        let materialOrderFieldCount = 0;
        const MAX_MATERIAL_ORDERS = 10;

        function addMaterialOrderField(materialList) {
            if (materialOrderFieldCount >= MAX_MATERIAL_ORDERS) {
                alert('最大10点まで発注できます。');
                return;
            }

            // 資材リストを保存（次回追加時に使用）
            if (materialList && materialList.length > 0) {
                materialOrderOptions = materialList;
            }

            const materialOrderList = document.getElementById('materialOrderList');
            if (!materialOrderList) {
                console.error('materialOrderList要素が見つかりません');
                return;
            }

            const fieldIndex = materialOrderFieldCount;
            materialOrderFieldCount++;

            const materialField = document.createElement('div');
            materialField.className = 'form-group';
            materialField.style.border = '1px solid #ddd';
            materialField.style.padding = '10px';
            materialField.style.marginBottom = '10px';
            materialField.style.borderRadius = '4px';
            materialField.id = `materialOrderField_${fieldIndex}`;

            materialField.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 3;">
                        <label style="font-size: 12px; color: #666;">資材 ${fieldIndex + 1}:</label>
                        <select class="material-order-select" data-index="${fieldIndex}" style="width: 100%;" required>
                            <option value="" disabled selected>選択してください</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #666;">数量:</label>
                        <input type="number" class="material-order-quantity-input" data-index="${fieldIndex}" min="1" step="1" style="width: 100%;" required>
                    </div>
                    <button type="button" class="remove-material-order-btn" data-index="${fieldIndex}" style="background-color: #f44336; color: white; padding: 6px 10px; margin-top: 20px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; flex-shrink: 0; width: 60px;">削除</button>
                </div>
            `;

            materialOrderList.appendChild(materialField);

            // 資材リストを設定
            const select = materialField.querySelector('.material-order-select');
            if (select && materialOrderOptions && materialOrderOptions.length > 0) {
                materialOrderOptions.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name + ' (' + item.id + ')';
                    select.appendChild(option);
                });
            } else if (materialOrderOptions.length === 0) {
                console.error('資材リストが設定されていません');
            }

            // 削除ボタンのイベント
            const removeBtn = materialField.querySelector('.remove-material-order-btn');
            removeBtn.addEventListener('click', function() {
                materialField.remove();
                materialOrderFieldCount--;
                updateMaterialOrderFieldNumbers();
                updateMaterialOrderAddButton();
            });

            // 追加ボタンの表示/非表示を更新
            updateMaterialOrderAddButton();
        }

        function updateMaterialOrderFieldNumbers() {
            const fields = document.querySelectorAll('.material-order-select');
            fields.forEach((field, index) => {
                const fieldDiv = field.closest('.form-group');
                const label = fieldDiv.querySelector('label');
                if (label) {
                    label.textContent = `資材 ${index + 1}:`;
                }
                field.setAttribute('data-index', index);
                const qtyInput = fieldDiv.querySelector('.material-order-quantity-input');
                const removeBtn = fieldDiv.querySelector('.remove-material-order-btn');
                if (qtyInput) qtyInput.setAttribute('data-index', index);
                if (removeBtn) removeBtn.setAttribute('data-index', index);
                fieldDiv.id = `materialOrderField_${index}`;
            });
        }

        function updateMaterialOrderAddButton() {
            const addBtn = document.getElementById('addMaterialOrderBtn');
            if (addBtn) {
                if (materialOrderFieldCount >= MAX_MATERIAL_ORDERS) {
                    addBtn.disabled = true;
                    addBtn.style.opacity = '0.5';
                    addBtn.style.cursor = 'not-allowed';
                } else {
                    addBtn.disabled = false;
                    addBtn.style.opacity = '1';
                    addBtn.style.cursor = 'pointer';
                }
            }
        }

        function addBomMaterialField(materialList) {
            if (materialFieldCount >= MAX_MATERIALS) {
                alert('最大8点まで登録できます。');
                return;
            }

            // 資材リストを保存（次回追加時に使用）
            if (materialList && materialList.length > 0) {
                materialOptions = materialList;
            }

            const materialsList = document.getElementById('bomMaterialsList');
            if (!materialsList) {
                console.error('bomMaterialsList要素が見つかりません');
                return;
            }

            const fieldIndex = materialFieldCount;
            materialFieldCount++;

            const materialField = document.createElement('div');
            materialField.className = 'form-group';
            materialField.style.border = '1px solid #ddd';
            materialField.style.padding = '10px';
            materialField.style.marginBottom = '10px';
            materialField.style.borderRadius = '4px';
            materialField.id = `materialField_${fieldIndex}`;

            materialField.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 3;">
                        <label style="font-size: 12px; color: #666;">資材 ${fieldIndex + 1}:</label>
                        <select class="bom-material-select" data-index="${fieldIndex}" style="width: 100%;">
                            <option value="" disabled selected>選択してください</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #666;">必要数:</label>
                        <input type="number" class="bom-quantity-input" data-index="${fieldIndex}" min="0.01" step="0.01" style="width: 100%;" required>
                    </div>
                    <button type="button" class="remove-material-btn" data-index="${fieldIndex}" style="background-color: #f44336; color: white; padding: 6px 10px; margin-top: 20px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; flex-shrink: 0; width: 60px;">削除</button>
                </div>
            `;

            materialsList.appendChild(materialField);

            // 資材リストを設定
            const select = materialField.querySelector('.bom-material-select');
            if (select && materialOptions && materialOptions.length > 0) {
                materialOptions.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name + ' (' + item.id + ')';
                    select.appendChild(option);
                });
            } else if (materialOptions.length === 0) {
                console.error('資材リストが設定されていません');
            }

            // 削除ボタンのイベント
            const removeBtn = materialField.querySelector('.remove-material-btn');
            removeBtn.addEventListener('click', function() {
                materialField.remove();
                materialFieldCount--;
                updateMaterialFieldNumbers();
                updateAddButton();
            });

            // 追加ボタンの表示/非表示を更新
            updateAddButton();
        }

        function updateMaterialFieldNumbers() {
            const fields = document.querySelectorAll('.bom-material-select');
            fields.forEach((field, index) => {
                const fieldDiv = field.closest('.form-group');
                const label = fieldDiv.querySelector('label');
                if (label) {
                    label.textContent = `資材 ${index + 1}:`;
                }
                field.setAttribute('data-index', index);
                const qtyInput = fieldDiv.querySelector('.bom-quantity-input');
                const removeBtn = fieldDiv.querySelector('.remove-material-btn');
                if (qtyInput) qtyInput.setAttribute('data-index', index);
                if (removeBtn) removeBtn.setAttribute('data-index', index);
                fieldDiv.id = `materialField_${index}`;
            });
        }

        function updateAddButton() {
            const addBtn = document.getElementById('addMaterialBtn');
            if (addBtn) {
                if (materialFieldCount >= MAX_MATERIALS) {
                    addBtn.disabled = true;
                    addBtn.style.opacity = '0.5';
                    addBtn.style.cursor = 'not-allowed';
                } else {
                    addBtn.disabled = false;
                    addBtn.style.opacity = '1';
                    addBtn.style.cursor = 'pointer';
                }
            }
        }

        // Handle custom quantity toggle
        function toggleCustomQty(select) {
            const customGroup = document.getElementById('customQtyGroup');
            const customInput = document.getElementById('customQty');

            if (select.value === 'custom') {
                customGroup.classList.remove('hidden');
                customInput.required = true;
            } else {
                customGroup.classList.add('hidden');
                customInput.required = false;
            }
        }

        // 商品名選択時の処理
        function onProductNameSelected(select) {
            if (!select || !select.value) {
                return;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            const productNumber = select.value;
            const productName = selectedOption.getAttribute('data-product-name') || selectedOption.textContent.split(' (')[0];
            
            // 商品番号と商品名を自動入力
            const productNumberInput = document.getElementById('productNumber');
            const productNameInput = document.getElementById('productName');
            
            if (productNumberInput) {
                productNumberInput.value = productNumber;
            }
            if (productNameInput) {
                productNameInput.value = productName;
            }
        }

        // 商品番号入力時の処理（自動補完）
        function onProductNumberInput(input) {
            if (!input || !input.value) {
                return;
            }
            
            // 商品番号を6桁にパディング（先頭0を保持）
            let productNumber = input.value.trim();
            // 数字のみを抽出
            productNumber = productNumber.replace(/[^0-9]/g, '');
            // 6桁にパディング（先頭に0を追加）
            if (productNumber.length < 6) {
                productNumber = productNumber.padStart(6, '0');
            }
            // 6桁を超える場合は先頭6桁のみ使用
            if (productNumber.length > 6) {
                productNumber = productNumber.substring(0, 6);
            }
            
            // 入力フィールドに正規化した値を設定
            if (input.value.trim() !== productNumber) {
                input.value = productNumber;
            }
            
            // 6桁未満の場合は商品名を設定しない（入力途中の可能性があるため）
            if (productNumber.length < 6) {
                return;
            }
            
            const productList = window.productList || [];
            
            if (productList.length === 0) {
                console.warn('商品リストが読み込まれていません');
                return;
            }
            
            // 商品番号で検索（正規化して比較）
            const normalizedSearchNumber = productNumber.padStart(6, '0');
            const product = productList.find(item => {
                if (!item.productNumber) {
                    return false;
                }
                // 両方の商品番号を6桁にパディングして比較
                const itemNumber = String(item.productNumber).trim().padStart(6, '0');
                return itemNumber === normalizedSearchNumber;
            });
            
            if (product && product.productName) {
                // 商品名を自動入力
                const productNameInput = document.getElementById('productName');
                if (productNameInput) {
                    productNameInput.value = product.productName;
                    // 入力イベントを発火して、値が設定されたことを確認
                    productNameInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // 商品名リストボックスも更新（商品番号を正規化して検索）
                const productNameSelect = document.getElementById('productNameSelect');
                if (productNameSelect) {
                    // オプションの中から一致するものを探す
                    for (let i = 0; i < productNameSelect.options.length; i++) {
                        const option = productNameSelect.options[i];
                        const optionValue = String(option.value).trim().padStart(6, '0');
                        if (optionValue === normalizedSearchNumber) {
                            productNameSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            } else {
                // 商品が見つからない場合は商品名をクリアしない（手入力の可能性があるため）
                // ただし、商品番号が6桁で完全な場合は警告を表示
                const productNameInput = document.getElementById('productName');
                if (productNameInput && !productNameInput.value.trim()) {
                    // 商品名が空の場合のみ警告（手入力されている場合は警告しない）
                    console.warn(`商品番号 "${productNumber}" に対応する商品が見つかりませんでした`);
                }
            }
        }

        // Handle form submission
        function handleSubmit(e) {
            e.preventDefault();
            const form = document.getElementById('dataForm');
            const mode = form.mode.value;
            const formData = {
                mode: mode
            };
            
            // バリデーション
            if (mode === 'REGISTER_BOM') {
                // BOM登録モード
                const productId = form.productId.value;
                if (!productId) {
                    alert('商品を選択してください。');
                    return;
                }
                
                formData.productId = productId;
                const materials = [];
                const materialSelects = document.querySelectorAll('.bom-material-select');
                const quantityInputs = document.querySelectorAll('.bom-quantity-input');
                
                materialSelects.forEach((select, index) => {
                    const materialId = select.value;
                    const quantity = quantityInputs[index] ? parseFloat(quantityInputs[index].value) : 0;
                    if (materialId && quantity > 0) {
                        materials.push({
                            materialId: materialId,
                            quantity: quantity
                        });
                    }
                });
                
                if (materials.length === 0) {
                    alert('少なくとも1つの資材を登録してください。');
                    return;
                }
                
                formData.materials = materials;
            } else if (mode === 'MANUFACTURE_PRODUCT') {
                // 製造業者選択モード
                const itemId = form.itemId.value;
                if (!itemId) {
                    alert('製造業者を選択してください。');
                    return;
                }
                formData.itemId = itemId;
            } else if (mode === 'RECEIVE_PRODUCT') {
                // 商品受注モード
                const clientOrderNumber = form.clientOrderNumber.value.trim();
                let productNumber = form.productNumber.value.trim();
                let productName = form.productName.value.trim();
                const deliveryDate = form.deliveryDate.value;
                
                // バリデーション
                if (!clientOrderNumber) {
                    alert('相手先の発注番号を入力してください。');
                    return;
                }
                if (!/^[0-9]{7}$/.test(clientOrderNumber)) {
                    alert('相手先の発注番号は7桁の数字で入力してください。');
                    return;
                }
                
                if (!productNumber) {
                    alert('商品番号を入力してください。');
                    return;
                }
                
                // 商品番号を6桁に正規化
                productNumber = productNumber.replace(/[^0-9]/g, '');
                if (productNumber.length < 6) {
                    productNumber = productNumber.padStart(6, '0');
                }
                if (productNumber.length > 6) {
                    productNumber = productNumber.substring(0, 6);
                }
                
                if (!/^[0-9]{6}$/.test(productNumber)) {
                    alert('商品番号は6桁の数字で入力してください。');
                    return;
                }
                
                // 商品名が空の場合、商品番号から商品名を取得
                if (!productName) {
                    const productList = window.productList || [];
                    const product = productList.find(item => {
                        if (!item.productNumber) {
                            return false;
                        }
                        const itemNumber = String(item.productNumber).trim().padStart(6, '0');
                        return itemNumber === productNumber;
                    });
                    
                    if (product && product.productName) {
                        productName = product.productName;
                        // 商品名フィールドに設定
                        const productNameInput = document.getElementById('productName');
                        if (productNameInput) {
                            productNameInput.value = productName;
                        }
                    } else {
                        alert('商品番号に対応する商品が見つかりません。商品名を手入力してください。');
                        return;
                    }
                }
                
                if (!deliveryDate) {
                    alert('納期を選択してください。');
                    return;
                }
                
                let quantity = form.quantitySelect.value === 'custom' ? form.customQty.value : form.quantitySelect.value;
                quantity = parseInt(quantity);
                
                if (isNaN(quantity) || quantity <= 0) {
                    alert('数量は1以上の整数を入力してください。');
                    return;
                }
                
                formData.clientOrderNumber = clientOrderNumber;
                formData.productNumber = productNumber;
                formData.productName = productName;
                formData.deliveryDate = deliveryDate;
                formData.quantity = quantity;
            } else if (mode === 'CREATE_DELIVERY_RESPONSE') {
                // 納期回答書作成モード
                const orderDate = form.orderDateSelect.value;
                if (!orderDate) {
                    alert('受注日を選択してください。');
                    return;
                }
                formData.orderDate = orderDate;
            } else {
                // 資材発注モード
                const materialOrders = [];
                const materialSelects = document.querySelectorAll('.material-order-select');
                const quantityInputs = document.querySelectorAll('.material-order-quantity-input');
                
                materialSelects.forEach((select, index) => {
                    const materialId = select.value;
                    const quantity = quantityInputs[index] ? parseInt(quantityInputs[index].value) : 0;
                    if (materialId && quantity > 0) {
                        materialOrders.push({
                            materialId: materialId,
                            quantity: quantity
                        });
                    }
                });
                
                if (materialOrders.length === 0) {
                    alert('少なくとも1つの資材を発注してください。');
                    return;
                }
                
                const expectedReceiptDate = form.expectedReceiptDate ? form.expectedReceiptDate.value : '';
                
                formData.materialOrders = materialOrders;
                formData.expectedReceiptDate = expectedReceiptDate;
            }

            // Disable button to prevent double submit
            const btn = form.querySelector('button');
            btn.disabled = true;
            btn.textContent = '送信中...';

            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(showError)
                .processForm(formData);
        }

        function onSuccess(result) {
            if (result && result.message) {
                alert(result.message);
            }
            google.script.host.close();
        }

        function showError(error) {
            alert('エラーが発生しました: ' + error.message);
            document.querySelector('button').disabled = false;
            document.querySelector('button').textContent = '送信';
        }

        // Load data from GAS on startup
        window.onload = function () {
            google.script.run
                .withSuccessHandler(function (response) {
                    init(response.mode, response.data, response.data2);
                })
                .withFailureHandler(showError)
                .getDialogData();
        };
    </script>
</body>

</html>