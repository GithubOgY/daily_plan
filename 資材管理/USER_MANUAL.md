# GAS 資材・売上管理システム 取り扱い説明書

## 目次
1. [システム概要](#システム概要)
2. [初期セットアップ](#初期セットアップ)
3. [基本操作](#基本操作)
4. [各機能の使い方](#各機能の使い方)
5. [よくある質問](#よくある質問)
6. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

このシステムは、Google Apps Script (GAS) を使用した資材・売上管理システムです。資材の発注から商品の製造、納品、売上記録まで一貫して管理できます。

### 主な機能
- 資材の発注・受領管理
- 商品の受注・製造・納品管理
- BOM（部品表）の登録・管理
- 在庫の自動管理
- 売上の自動記録
- 製造業者の管理

---

## 初期セットアップ

### 1. スプレッドシートの準備

新しいGoogleスプレッドシートを作成し、以下の7つのシート（タブ）を作成してください。

#### シート1: `Materials` (資材マスタ)
| A列 | B列 | C列 | D列 |
| :--- | :--- | :--- | :--- |
| **MaterialID** | **MaterialName** | **Unit** | **CurrentStock** |
| M001 | 木材 | kg | 0 |
| M002 | 鉄 | kg | 0 |

**説明**: 資材のマスター情報を登録します。CurrentStock（D列）は在庫数で、システムが自動的に更新します。

#### シート2: `Products` (商品マスタ)
| A列 | B列 | C列 |
| :--- | :--- | :--- |
| **ProductID** | **ProductName** | **SellingPrice** |
| P001 | 椅子 | 5000 |
| P002 | テーブル | 12000 |

**説明**: 販売する商品のマスター情報を登録します。SellingPrice（C列）は納品時の売上計算に使用されます。

#### シート3: `BOM` (部品表)
| A列 | B列 | C列 |
| :--- | :--- | :--- |
| **ProductID** | **MaterialID** | **QuantityRequired** |
| P001 | M001 | 2 |
| P001 | M002 | 1 |

**説明**: 各商品に必要な資材と数量を定義します。1つの商品に対して複数の資材を登録できます。

#### シート4: `Material_Orders` (資材発注ログ)
| A列 | B列 | C列 | D列 | E列 |
| :--- | :--- | :--- | :--- | :--- |
| **OrderID** | **Date** | **MaterialID** | **Quantity** | **Status** |
| MO-1001 | 2023-11-01 | M001 | 10 | Received |

**説明**: 資材の発注履歴を記録します。Statusは「Ordered」（発注済）または「Received」（受領済）です。

#### シート5: `Product_Orders` (商品受注ログ)
| A列 | B列 | C列 | D列 | E列 | F列 | G列 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **OrderID** | **Date** | **ClientName** | **ProductID** | **Quantity** | **Status** | **Manufacturer** |
| PO-2001 | 2023-11-05 | | P001 | 1 | Delivered | MFG001 |

**説明**: 商品の受注から納品までの履歴を記録します。
- **Status**: 「Ordered」（受注）、「Shortage」（資材不足）、「Manufactured」（製造済）、「Delivered」（納品済）
- **Manufacturer**（G列）: 製造業者ID（製造時に自動記録）

#### シート6: `Sales` (売上ログ)
| A列 | B列 | C列 | D列 | E列 | F列 | G列 | H列 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **OrderID** | **Date** | **ClientName** | **ProductID** | **Quantity** | **UnitPrice** | **TotalAmount** | **Manufacturer** |
| PO-2001 | 2023-11-05 | | P001 | 1 | 5000 | 5000 | MFG001 |

**説明**: 商品納品時の売上を自動記録します。納品時に自動的に追加されます。

#### シート7: `Manufacturers` (製造業者マスタ)
| A列 | B列 |
| :--- | :--- |
| **ManufacturerID** | **ManufacturerName** |
| MFG001 | 製造業者A |
| MFG002 | 製造業者B |

**説明**: 製造業者のマスター情報を登録します。

### 2. コードの設定

1. スプレッドシートのメニューから「拡張機能」→「Apps Script」を選択
2. 新しいプロジェクトが開いたら、以下のファイルを作成：
   - `Code.gs`: 提供されたGASコードを貼り付け
   - `Dialog.html`: 提供されたHTMLコードを貼り付け
3. ファイルを保存
4. スプレッドシートに戻り、ページを再読み込み
5. メニューに「資材管理システム」が表示されれば完了

---

## 基本操作

### メニューの表示
スプレッドシートを開くと、メニューバーに「資材管理システム」が表示されます。

### メニュー項目
1. **資材を発注する (新規行)** - 資材の発注を登録
2. **資材を受け取る (選択行)** - 資材の受領を記録
3. **商品を受注する (新規行)** - 商品の受注を登録
4. **商品を製造する (選択行)** - 商品の製造を記録
5. **商品を納品する (選択行)** - 商品の納品を記録
6. **BOMを登録する** - 部品表を登録・更新

---

## 各機能の使い方

### 1. 資材を発注する

**手順**:
1. メニューから「1. 資材を発注する (新規行)」を選択
2. ダイアログが開きます
3. 「資材と数量」セクションで：
   - 「資材」から発注する資材を選択
   - 「数量」に数量を入力
   - 複数の資材を発注する場合は「資材を追加 (+)」ボタンをクリック（最大10品目まで）
4. 不要な資材フィールドは「削除」ボタンで削除できます
5. 「受領予定日」を選択（オプション）
6. 「送信」ボタンをクリック

**結果**:
- `Material_Orders`シートに各資材ごとに新しい発注記録が追加されます
- 各資材ごとに個別の発注IDが生成されます
- Statusは「Ordered」（発注済）になります
- 発注完了メッセージに発注件数と発注IDが表示されます

---

### 2. 資材を受け取る

**手順**:
1. `Material_Orders`シートを開く
2. 受領する発注の行を選択（クリック）
3. メニューから「2. 資材を受け取る (選択行)」を選択

**結果**:
- 選択した行のStatusが「Received」（受領済）に更新されます
- `Materials`シートの在庫（CurrentStock）が自動的に増加します
- もし`Product_Orders`シートに「Shortage」（資材不足）状態の受注があり、在庫が十分になった場合は、自動的に「Ordered」に戻ります

**注意**: 
- 既に「Received」の行は処理できません
- データ行（2行目以降）を選択してください

---

### 3. 商品を受注する

**手順**:
1. メニューから「3. 商品を受注する (新規行)」を選択
2. ダイアログが開きます
3. 「商品を選択」から受注する商品を選択
4. 「数量」を選択（または「その他 (手入力)」で数値を入力）
5. 「送信」ボタンをクリック

**結果**:
- `Product_Orders`シートに新しい受注記録が追加されます
- システムが自動的に在庫をチェックします：
  - **在庫が十分な場合**: Statusは「Ordered」（受注）になります
  - **在庫が不足している場合**: Statusは「Shortage」（資材不足）になります
  - **BOMが登録されていない場合**: Statusは「Shortage」になり、警告メッセージが表示されます

**メッセージの意味**:
- 「受注完了: PO-xxxx (在庫確認済み、製造可能)」→ すぐに製造できます
- 「受注しましたが、製造できません (ステータス: Shortage)」→ 資材を補充する必要があります

---

### 4. 商品を製造する

**手順**:
1. `Product_Orders`シートを開く
2. 製造する受注の行を選択（クリック）
3. メニューから「4. 商品を製造する (選択行)」を選択
4. 製造業者選択ダイアログが開きます
5. 「製造業者を選択」から製造業者を選択
6. 「送信」ボタンをクリック

**結果**:
- 選択した行のStatusが「Manufactured」（製造済）に更新されます
- 製造業者IDがG列に記録されます
- `Materials`シートの在庫が自動的に減少します（BOMに基づいて計算）

**注意**: 
- Statusが「Ordered」または「Shortage」の行のみ製造できます
- 在庫が不足している場合はエラーメッセージが表示されます
- データ行（2行目以降）を選択してください

---

### 5. 商品を納品する

**手順**:
1. `Product_Orders`シートを開く
2. 納品する受注の行を選択（クリック）
3. メニューから「5. 商品を納品する (選択行)」を選択

**結果**:
- 選択した行のStatusが「Delivered」（納品済）に更新されます
- `Sales`シートに売上記録が自動的に追加されます
- 売上金額が自動計算されます（商品の販売価格 × 数量）

**注意**: 
- Statusが「Manufactured」（製造済）の行のみ納品できます
- データ行（2行目以降）を選択してください

---

### 6. BOMを登録する

**手順**:
1. メニューから「6. BOMを登録する」を選択
2. ダイアログが開きます
3. 「商品を選択」からBOMを登録する商品を選択
4. 「資材と必要数」セクションで：
   - 「資材」から必要な資材を選択
   - 「必要数」に数量を入力（小数も可、例: 0.5）
   - 複数の資材を登録する場合は「資材を追加 (+)」ボタンをクリック（最大8点まで）
5. 不要な資材フィールドは「削除」ボタンで削除できます
6. 「送信」ボタンをクリック

**結果**:
- `BOM`シートに登録されます
- 既に同じ商品IDと資材IDの組み合わせが存在する場合は更新されます
- 新規の場合は追加されます

**例**:
- 商品P001に資材M001を2個、資材M002を1個登録する場合：
  1. 商品: P001を選択
  2. 資材1: M001、必要数: 2
  3. 「資材を追加 (+)」をクリック
  4. 資材2: M002、必要数: 1
  5. 送信

---

## よくある質問

### Q1. 在庫がマイナスになることはありますか？
A. いいえ。在庫が不足している場合は製造できません。エラーメッセージが表示されます。

### Q2. BOMを登録し忘れた場合、どうすればいいですか？
A. メニューから「6. BOMを登録する」を選択して、後から登録できます。登録後、受注のStatusが自動的に「Ordered」に更新される場合があります。

### Q3. 資材を受け取った後、Shortage状態の受注はどうなりますか？
A. 自動的にチェックされ、在庫が十分になった場合はStatusが「Ordered」に更新されます。メッセージで解決された受注IDが表示されます。

### Q4. 製造業者を変更したい場合は？
A. 現在のシステムでは、製造時に選択した製造業者が記録されます。変更する場合は、`Product_Orders`シートのG列を直接編集してください。

### Q5. 売上を確認するには？
A. `Sales`シートを確認してください。納品時に自動的に記録されます。

### Q6. 在庫を確認するには？
A. `Materials`シートのD列（CurrentStock）を確認してください。資材の受領や製造時に自動的に更新されます。

---

## トラブルシューティング

### エラー: 「シート "xxx" が見つかりません」
**原因**: シート名が正しく作成されていない、または名前が間違っている  
**対処**: `sheets_structure.md`を確認し、シート名が正確に一致しているか確認してください。

### エラー: 「数量が不正です」
**原因**: 数量が0以下、または数値以外が入力されている  
**対処**: 正の数値を入力してください。

### エラー: 「BOM(部品表)が登録されていません」
**原因**: 商品のBOMが登録されていない  
**対処**: メニューから「6. BOMを登録する」を選択して、BOMを登録してください。

### エラー: 「在庫が不足しています」
**原因**: 製造に必要な資材の在庫が不足している  
**対処**: 
1. `Materials`シートで在庫を確認
2. 不足している資材を発注
3. 資材を受け取る
4. 再度製造を試みる

### リストボックスに項目が表示されない
**原因**: マスタデータが登録されていない  
**対処**: 
- 資材発注の場合: `Materials`シートに資材を登録
- 商品受注の場合: `Products`シートに商品を登録
- 製造業者選択の場合: `Manufacturers`シートに製造業者を登録

### メニューが表示されない
**原因**: コードが正しく設定されていない、またはページが再読み込みされていない  
**対処**: 
1. Apps Scriptエディタでコードが正しく保存されているか確認
2. スプレッドシートのページを再読み込み（F5キー）
3. ブラウザのキャッシュをクリアして再試行

---

## ステータスの意味

### Material_Orders（資材発注ログ）
- **Ordered**: 発注済み（まだ受領していない）
- **Received**: 受領済み（在庫に追加済み）

### Product_Orders（商品受注ログ）
- **Ordered**: 受注済み（在庫が十分で製造可能）
- **Shortage**: 資材不足（在庫が不足しているため製造不可）
- **Manufactured**: 製造済み（資材を消費し、製造が完了）
- **Delivered**: 納品済み（売上として記録済み）

---

## データの流れ

### 資材の流れ
```
資材発注 → 資材受領 → 在庫増加
```

### 商品の流れ
```
商品受注 → 在庫チェック → 製造 → 在庫減少 → 納品 → 売上記録
```

### 在庫の自動更新
- **資材受領時**: 在庫が増加
- **商品製造時**: 在庫が減少（BOMに基づいて計算）
- **Shortage解決**: 資材受領時に自動チェック

---

## 注意事項

1. **データの直接編集**: システムが自動更新する列（Status、CurrentStockなど）は直接編集しないでください
2. **BOMの登録**: 商品を製造する前に、必ずBOMを登録してください
3. **在庫管理**: 在庫はシステムが自動管理します。手動で変更する場合は注意してください
4. **IDの一意性**: MaterialID、ProductID、ManufacturerIDは重複しないようにしてください

---

## サポート

問題が発生した場合は、以下を確認してください：
1. `DEVELOPMENT_LOG.md` - 開発履歴と技術的な詳細
2. `sheets_structure.md` - シート構造の詳細
3. ブラウザの開発者ツール（F12）のコンソールでエラーメッセージを確認

---

**最終更新日**: 2024年  
**バージョン**: 1.2

